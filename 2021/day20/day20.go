package main

import (
	"flag"
	"fmt"
	"log"
	"strings"
	"time"
)

func main() {
	start := time.Now()
	log.Printf("Starting...")

	testInputPtr := flag.Bool("testInput", false, "a bool")
	flag.Parse()

	if *testInputPtr {
		fmt.Println("Using test Input")
		input = inputTest
	}

	imgAlg, img := parseInput(input)

	// Assuming background stays dark or alternates between light and dark.
	backgroundAlternateValue := enhance([][]bool{{false, false, false}, {false, false, false}, {false, false, false}}, imgAlg, 1, 1)
	revert := enhance([][]bool{{backgroundAlternateValue, backgroundAlternateValue, backgroundAlternateValue}, {backgroundAlternateValue, backgroundAlternateValue, backgroundAlternateValue}, {backgroundAlternateValue, backgroundAlternateValue, backgroundAlternateValue}}, imgAlg, 1, 1)
	if revert {
		panic("Background not consistent") // revert should be false, so if true we have an issue
	}
	backgroundValues := [2]bool{false, backgroundAlternateValue}

	for iteration := 0; iteration < 51; iteration++ {
		img = tickImg(img, imgAlg, backgroundValues, iteration)
		if iteration == 1 { // enhanced twice
			fmt.Println("Part 1: ", sumImg(img))
		}
		if iteration == 49 { //enhanved 50 times
			fmt.Println("Part 2: ", sumImg(img))
			break
		}
	}

	log.Printf("Duration: %s", time.Since(start))
}

func tickImg(img [][]bool, imgAlg [512]bool, backgroundValues [2]bool, iteration int) [][]bool {

	background := backgroundValues[iteration%2]

	// fmt.Println("Inocoming")
	// fmt.Println(printImg(img))

	// pad image by two
	img = padImg(img, background)

	// fmt.Println("Padded")
	// fmt.Println(printImg(img))

	img = enhanceImg(img, imgAlg)

	// fmt.Println("Enhanced")
	// fmt.Println(printImg(img))

	//trim img by one
	img = trimImg(img)

	// fmt.Println("Trimmed")
	// fmt.Println(printImg(img))

	return img
}

func padImg(img [][]bool, background bool) [][]bool {
	img2 := make([][]bool, len(img)+4)
	for i := range img2 {
		img2[i] = make([]bool, len(img[0])+4)
	}

	for y, line := range img2 {
		for x := range line {

			if 2 <= x && x < len(line)-2 && 2 <= y && y < len(img2)-2 {
				// fmt.Println("Copying from original", x, y)
				img2[y][x] = img[y-2][x-2]
			} else {
				// fmt.Println("Setting Background", x, y)
				img2[y][x] = background
			}
		}
	}

	return img2

}

func enhanceImg(img [][]bool, imgAlg [512]bool) [][]bool {
	img2 := make([][]bool, len(img))
	for i := range img2 {
		img2[i] = make([]bool, len(img[0]))
	}

	for y := 1; y <= len(img)-2; y++ {
		for x := 1; x <= len(img[0])-2; x++ {
			img2[y][x] = enhance(img, imgAlg, x, y)
		}
	}
	return img2
}

func trimImg(img [][]bool) [][]bool {
	img = img[1 : len(img)-1]

	for i, line := range img {
		img[i] = line[1 : len(line)-1]
	}

	return img
}

func sumImg(img [][]bool) int {
	count := 0
	for _, line := range img {
		for _, pixel := range line {
			if pixel {
				count++
			}
		}
	}
	return count
}

func enhance(img [][]bool, imgAlg [512]bool, x, y int) bool {
	pwr, imgAlgIndex := 0, 0

	// right to left, bottom to top
	for dy := 1; dy >= -1; dy-- {
		for dx := 1; dx >= -1; dx-- {
			if img[y+dy][x+dx] {
				imgAlgIndex += twoPow(pwr)
			}
			pwr++
		}
	}

	return imgAlg[imgAlgIndex]
}

func twoPow(n int) int {
	if n == 0 {
		return 1
	}
	result := 2
	for i := 2; i <= n; i++ {
		result *= 2
	}
	return result

}

func parseInput(input string) ([512]bool, [][]bool) {

	inputSplit := strings.Split(input, "\n\n")

	var imgAlg [512]bool

	for i, c := range strings.Split(inputSplit[0], "") {
		imgAlg[i] = (c == "#")
	}

	imgLines := strings.Split(inputSplit[1], "\n")

	height, width := len(imgLines), len(imgLines[0])

	img := make([][]bool, height)
	for i, line := range imgLines {
		img[i] = make([]bool, width)
		for j, c := range strings.Split(line, "") {
			img[i][j] = (c == "#")
		}
	}
	return imgAlg, img
}

func printImg(img [][]bool) string {
	imgString := ""
	for _, line := range img {
		for _, pixel := range line {
			if pixel {
				imgString += "#"
			} else {
				imgString += "."
			}
		}
		imgString += "\n"
	}
	return imgString
}

var inputTest string = `..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..###..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#..#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#......#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#.....####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.......##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#

#..#.
#....
##..#
..#..
..###`

var input string = `###....#.#.#.#.##...#####....##.#..##...##...##..##.######..##.##......#...#.####..#.....##...##.######..##....#...###.##.####.##.####....###..#...##....##...##.###...####.#.##..#..#....#####.#..#...#.#..##..#..##.#.##.#.##...#######.####.#.#..#......##.#...##.#..##....#.###.##.#..####.#......#..#..##.....#.####..#####..###.######..#......####.###.##....##.#.#####..##.#####....#.###..###.#..#..##.##..#.##..###....##.###..#.##.#..########....###.####..##..###..#.#..######..#.##.####.##...#####....#........#.

###.....##...#...#....##..#####.#.#.#.#..###.#.##.##..##.#...#..#.#.#...##.##.#.##.###..###...#.####
...##..#.#..#...##.#..#.#..##.#####..#....#.#.#..##..#...###...##.#..#.##..##..#...####.#.##..#.####
.#.#.###..#......###...##.....##..##.######..##.#..##.#..#.#######.##....#.#####.#...#..######.#.###
..#..##....#.##.##..##.######.##....#.#.#.########.##..#....##.######........######..#.#.###.....#..
#.#.#.#.##....##.#.###....##..#.#.####..##...#.....##.###..####.##..##..##.#.#.#.##..##..####.#.#.#.
.#...#.....#.####.......###.#.#.....#.##.#####....##...#..#...###.#.######.#..#.##...#.###.#..####..
..#.##.############.###...######...##.###.#....#####...####.##....##.##.#.##..###.........#.#.....#.
...##.##...###.#.###.#.#.##..##.###..#.###.##.###.#.......##.....#.#.##...#.##...#.###.......#.###.#
.####...###..#.##.#.##....#.#.#.#####.......######..#..##..#..#.#.##.#...#.#........#..##.###...#.##
.###.###..#...##..######...#..###..#.##.#.#.#..##.#..##..#...##.#....#.#.###..##.#.##.##.........#..
.#######..##..##.#...#.#..##.##..###....##..#.#.##.##..#.#.###..#...###.......#.#.#....##.#..##..#..
.#....#.#.#.###....##.#.#.#.#.......##...#......#....#.##...#.#..#...###.###.#..#...#.##.###.#####.#
......#....#.#.##.###.#####.#..##..#..###........##...#####...#...#...#.###.#####.#.#.##.#...####...
.#.#####.#...#...#.#.###....#..##.#..####.##.#########...##.#..##..#..##...#...#.#.#.##......##.#.#.
.#.##.######.###......###....#...###.#.##........#......##...#...#.#.....#...##...#..#...#.####...##
#..#..#...###..##.#...#...#..#####.##.....#.###.##.#####.##.##.#.#..##.##..###.######.#....#.####..#
#..#.##.##....#.##..##....#######.#..#.####.#.#.....#.#..#..##.#.#....#.#..#####.#.#.########..#####
#..#.#.#......#.#######.##.#...#..#.#.#..###.#..###.#.########..##.##.#...##.##....###..###..#####.#
.#..#.#..###.#..#.#..###.##.#...###..##.##..##..#..#.#.###.##.#...#...##.##......#.....##..##.......
#..##..###.#.......#.####.##..##..#..###.##..#..##...#......##...######....##.###..#..#.#...#.#...##
#..#..#.##...#####.....####....#.####..#####.##..##..#....##..#.##.###......##..##.##...###..#..###.
#..##....#.#...####.#...#....#.......####.##.#.##.##..#...#####.#..##....#.#..#..#...#..#.##...##..#
.#..##..#.#...###.#.####.##...#..#....##.##...#.#.##.######.##..#.#######....###.#.##.###.#.#....#.#
#......##.###...#..#..#..#..#....#..##....#..##.#.##...#.#.####.##.#.##.#...##.###.####..#...##..#..
##.....##.#...##...####....#....#...###..##.#...#.#...#...#..#########..#....##.#..######.#.###.##..
#....#....###.##.#..##.#.#.#####.#####....###..##....###.#.#.#..#.#....#...#.##.###....#..#...#.#...
..##..#..##..#.##.##.#..###.##.....#...###.####..#..#..##.##.#..#####......####...###.##.#.##....#.#
#.####.##..#.#.....#.#.##.#.##.##.#.##....##.#.#.....#..#.##.##..####.###.#..#..####.#.##..#.##.#...
.#..#.###...##.##..##..#..###.....##.#....#.#..#.....##....#..##..#..#.#.##.......##.##...#.#....#.#
##.#.#####..#..##.#....##.###....#.#.#..#..##..####......#..####...#.#####....####.###.##...##.#....
##..#.##..#..###.#########.#..#..##.##.##.####.....#.##.####.#.##.##.#..###...#####...##.##....#..##
##..###..#.##..#.#.....#...#...##..##..##...#.###...####....##.##....#.#..#######.####..#..#.#####.#
...##..#.#....##.##...#...##.#.##.###.#..###..#.###.##.###...##...#.#..###..#.##.####.#.##...#....##
##..#.#.#.#.#.##..#..##.#.##..#...##.#.##..###...#.##.#.##....#.########..##..###..#####.###..#.....
#.#.#..##...##.###....#.###...##.#####.#...##...##.##..#.#.#.#####....#..##.##....###.##.#..##.#..#.
###...##...##......##.###.#.#..#..#..#...#..#.#.##..##..##........#..##.##...#..##..##.....##...#.#.
..#.###...###.....#.#.#.##.........###...#.#..#.##...#.##.#...##.##..##.#.#.#.##.##..#.##...#..##...
#.##..#..#.....#.#.#..#.#..##.####...#.##.###..##..###..#.#...#####....#...##.####.#.###.#.##..###.#
#..#.#.#..#.#####.####...######.####..###.#.##...#.....##...#.#.#..#..#.#..#...##.#..#.#..#..####.#.
..#.#.#.#######.#..#..#.#..#......#.##...#.#.###.#...#..#..#....##.#..#.#...#..#.#.##.#..#.#.##.####
#.#.#.####...#...#.###.##..##.####.##.#...#.#..##...##...#..#.#.#.###...#..#.###..#..#.#.#.#.####.##
....#####.##.#..##..#..##.#.#.#..#.#.#...#.####..#.#.#..##..##.#...#....#.#.#.###..##...##...#.####.
.#.#.#####.#..#..#.#.#.##.##.#.####..#...####.#.#.####..##.##.##..#..###.#.#.##.###.#...####.##..##.
####..##..###.#.#.....#.##..#.#.##..#...##.....#.....#.#.#.#.#.#.###.####.##....##..#.##..#..#.####.
#...###.#.#.#..###.#.#.#.#..###..#.....#.##.##.....#######.###....#.#####.#..####.####.#..####.##..#
##..#######.....##..#..#....#.#..#..#..###.##..#...##.#..##.....#####......###...#.###.#.#.#####.#..
##.##.#..#.#.#.#.#..##.####.#.#.#.####..#.#.....###.###..########.##.###.###.###.#.....##.....#.#.##
##.#.#.##.....#...##.###.#.##.#..#..##.....###........#....#.#...##.#.##..####..####.#..#..#.#...#.#
.####..#..#..#..#......#.##..#..###...#######.#..#.###....###...#....#..###..####..##.#.#.#..##.####
...######..........###....#...###..#..####..##.##.#.##..##.####..#.##.#.#.##.###.#..#..#.#....##.###
#...#......#.#..#.......#.###....#.####....###.....#.#.#.###..##..######...#####.#...####.###....#..
.##..##.#.....#....####..#####.#.#.##..#...#.##.....#.#.##..##.####.###.#####.##.#.##...#.##...#.#.#
###...#..##.#.#....#.###.#####..###..####.#..#....###..#.#.#.....##.#.###..##...#..#.#.#..#..#..#.##
.#..#.....#.##.###.##..#.#.#..######.##..#.###.#.#...##..##.#.##.#...#.#####.##.#...#.#.##.#####.###
..#.#.##.#..#.#.......#...#.#.##..###.#..#####...##.....####..########..#############.#..######...##
#.##...##..#...###...#.####.##......##.###..##...##..###..##...###....#..#..#.###..#.##.######.....#
..#.#......##..##.....###.###..#..####.#.#...#.##....#..##.#..#.##.#.##.##.#..#......###.....####.#.
##...####.##....#...##...##..#.#.#..##.#...###.#.##.######..#.##.##..###.#.#.#.#...####.#..#..#.....
####.####..#.....#......######.#.###.##.###.######..#...#.#.###....#.##.#####.#####..#.#.#....####..
.###....###.###...##....#.#.###....#..#...##.##...#.....###..###.#.##..#..###..#.#..##...#...#..#...
#.##..#.######..##..#...#.###..#.###..##..######.##.....##..#..####.##........##.###..#.##.#...##...
#.#.##.###.#..##...####..###...###..#.###.###.######..#...##....###.....#..#....#.....#.#...###....#
#.##.#..##..#....####..#.###.##..##...#.#.###..##..##...#..#.#..##.#.###..##.##.....#.#.#######...#.
#.##.####...##...#.#.#..###......##.#.#.#.#.##.####.#..#....##..#.....#.###.#.##..#.##.##..#..#.#...
.#..###.#.#.#.#.###.##.#####.....#...##...##..#........#.###..#.#.##.#..#####....#.#####.#.#..###...
##.#.#####.#.######.##.######...#.##.#.#.#......##.#.#..#####.#...#.########..#.....#..#..#.###..###
#.###.##..#..###....##.##.###..####....##.##..##...##..###...##.....##..##.##.#.#.#...####.#..###.#.
#.##..##......###.#.###.###.######.#.#.####..#.#..#.##...##.#.#..##.##.##...######.##.#.......#.#..#
#.#####.#...#.##...#..#.####.##.#....#####.###...##.#.###..#..#####..###.#..##.....##.##.#..##.####.
..###..#.########.###..####...#.#...##.#.#.#.#.#####.#.#.###.##....#..#.#.#...###....####....#..#.#.
.###..#...##.#...##...##.##.####..#..#..#..##..##.#.#...#.##.#.##.#.#...##..#.#..#.#.#.###...#....##
#.##.###...#.###.#..###..#.#.#.....#######..#.#..#.#####.#...##.#..##.####.##.#.#.###....###...#..#.
.###.#.##.#.####.#.##.#...#.##...#.###.##.##.#.##..##..####...#.#...###..#.##..#.####..###.#.#.#...#
#..#####.#####..#.#.####.####.####.###.##.##.###.#.#..###..........###.##.#.#.#....#.#.##........#.#
##..#.###.......##.####.###.#.##.##.##.##.#..#..#.#.#....###.####..####.##..##.##.....###...##.#....
#....##.##..#.....######..#..##.##..###.###..###.##.#..####..#.#.#.#.#.##.#....#.#.#.#.#####.#..#.#.
....##..#.##.###.##..###....#....###.#.###......#.......####..#.####.###..###.#......###..#.##.#...#
.##..#.#.##..##.###..####.#....###..####..#.#.##..##....####...###.#.....#..#.....#.##.#.#........#.
#..##.##..##...#.#.#....##.#.##.#.#.#.##.#...#.##..####..#####..#..#.....##..#.##...###.......#....#
##...###..#....#.#.######.##.####.##..##.####.##..##..#....#...########...###.##....#..#......##..##
...##.#.#.##.#######.##.#...##..##..##...#.#.##.#..#..#.#####..##..#...#.##.#....##.#..##.#..#.#.#.#
.....##############.##......###.#.....#.###...##..#.#.#.####.####.....#.##.###.##.........#.#.###..#
.#....##......#.####.#...#.######.....###....##..##..#.##..####...##.......#####...#.####..#....#.#.
..#..#########.####......###.#.#####.#....#.#.#...##.###.#.....##.###.#......##..#.#######..##..#.##
.#.##.#.#....##....####..##..##..#.##..##.#...#....#...#.#.#...###...####....##..#.#.#.#.....#....##
.#..#..#.######....##.######.####...#.#..#....####..######..##.##.....##...##...#.##...#.#.#..#.##..
....##.#.##.#.#..####.###..##..#.####.##.###.##.....#...#.##.##.#.###..##..##.#.##.#.####.#......##.
#.#.##.....#......#####.#.###.#..##.#####.######.##.##.#..##.#....###.#.###...###...##..#.#........#
##...##..#....##..#..##.####......#.####..##.#.##.##..#.#.#######.#..###..##...#.###.#..#.##......##
##..#.#.....###.###.##...#.#.....#...#.##....#..########.##..##...##...###.#.#...####.#..#.#.##..#.#
########..#.#.####.#.#.###....##.#.....###..###...#.#..##.##.#.##.#.#..#.##..######...###.#..#..##..
.#.##...#..#.##...#.###.#####..#..#.####..######....##.#..##..##...#...#..###....##.###...#####...##
#.####...##.#..##.....#####..###......#..##.#...#####.##.#..#...####.##.#...#..#..#......###.#...#..
..#.######..#..#.#...##.#.#.##...#######.#..#.#..##.#..#.#.###.#.#..##..##.###.####.##.#.####...#..#
#.###.####.#.#.###.....#.#####.....##...#.#...#.##.#..#..#..#....#.#...#..#.###.#..#.######.###.####
..#..#####.....##.#......##.###..##...#.##.###...#.#.##.#..#...##.##.....##.####.#....###.#....#.###
......#..#.##..###.#.#..#....###..###.#..#.#.#...######...#.....#..#.##..#.###.##....#.##.#.#.#.##.#
###...#.####.##.#......#....##...#.#..#..#....##..##.#.#....###..##.#..#..###.##..#.#.#..#.#..##.##.
.#.###.#.#.####....####.#.##.#.##....##.##...#.###.###############..#.##.##..##..#######...#..#..###
##....#..#..#.###.#.#.###.#######.###.##.##.##.#.#.#.#.#....#..#...###.##.....###...###..###.#.##..#`
